---
interface Props {
  pageId: string;
  pageTitle: string;
  pageUrl?: string;
}

const { pageId, pageTitle, pageUrl } = Astro.props;
const CUSDIS_HOST = "https://comments.natinternet.com";
const APP_ID = "62274c3e-e32b-4dcc-a63f-cfbe2ef9959b";
const MOSPARO_HOST = "https://spam.natinternet.com";
const MOSPARO_UUID = "12554c7d-2385-4016-89d5-a63ebb80e01b";
const MOSPARO_PUBLIC_KEY = "7k08eDIgCvB4ViIQ3oIR8GkH_kdJDvFkapLKQt8USPI";
const fullUrl = pageUrl || Astro.url.href;
---

<div id="cusdis_thread"
  data-host={CUSDIS_HOST}
  data-app-id={APP_ID}
  data-page-id={pageId}
  data-page-url={fullUrl}
  data-page-title={pageTitle}
  data-theme="light"
></div>

<!-- Mosparo container for validation -->
<div id="mosparo-box" style="display:none;"></div>

<script is:inline>
  window.CUSDIS_LOCALE = {
    powered_by: 'Comments',
    post_comment: 'Post Comment',
    loading: 'Loading...',
    email: 'Email (optional)',
    nickname: 'Name',
    reply_placeholder: 'Write a comment...',
    reply_btn: 'Reply',
    sending: 'Sending...',
  };
  window.CUSDIS_PREVENT_INITIAL_RENDER = true;
</script>

<!-- Mosparo Resources -->
<link href="https://spam.natinternet.com/resources/12554c7d-2385-4016-89d5-a63ebb80e01b.css" rel="stylesheet">
<script is:inline src="https://spam.natinternet.com/build/mosparo-frontend.js" defer></script>

<!-- Cusdis SDK -->
<script is:inline src="https://comments.natinternet.com/js/cusdis.umd.js" defer></script>

<script is:inline>
  let mosparoInstance = null;
  
  // Initialize Mosparo
  function initMosparo() {
    if (typeof mosparo !== 'undefined' && !mosparoInstance) {
      mosparoInstance = new mosparo(
        'mosparo-box',
        'https://spam.natinternet.com',
        '12554c7d-2385-4016-89d5-a63ebb80e01b',
        '7k08eDIgCvB4ViIQ3oIR8GkH_kdJDvFkapLKQt8USPI',
        {
          loadCssResource: false,
          onCheckForm: function(valid) {
            window._mosparoValid = valid;
          }
        }
      );
    }
  }

  // Watch for Cusdis form creation and attach spam protection
  function attachSpamProtection() {
    const observer = new MutationObserver(function(mutations) {
      const form = document.querySelector('#cusdis_thread form');
      if (form && !form.dataset.mosparoAttached) {
        form.dataset.mosparoAttached = 'true';
        
        // Add Mosparo validation on submit
        form.addEventListener('submit', function(e) {
          if (!window._mosparoValid) {
            if (mosparoInstance) {
              mosparoInstance.checkForm();
            }
          }
        });
        
        // Move mosparo box inside form
        const mosparoBox = document.getElementById('mosparo-box');
        if (mosparoBox) {
          mosparoBox.style.display = 'block';
          mosparoBox.style.marginTop = '10px';
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.parentNode.insertBefore(mosparoBox, submitBtn);
          }
        }
        
        observer.disconnect();
      }
    });
    
    observer.observe(document.getElementById('cusdis_thread'), {
      childList: true,
      subtree: true
    });
  }

  // Initialize everything when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    initMosparo();
    if (window.CUSDIS) {
      window.CUSDIS.initial();
    }
    attachSpamProtection();
  });
</script>

<style>
  #mosparo-box {
    margin: 10px 0;
  }
</style>
